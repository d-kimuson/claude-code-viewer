import { describe, expect, it } from "vitest";
import { extractFirstUserMessage } from "./isValidFirstMessage";

const createUserConversation = (content: string, uuid: string) => {
  const userType: "external" = "external";
  const role: "user" = "user";
  const entryType: "user" = "user";

  return {
    type: entryType,
    isSidechain: false,
    userType,
    cwd: "/repo",
    sessionId: "session-1",
    version: "2.1.34",
    uuid,
    timestamp: "2026-02-07T00:00:00.000Z",
    parentUuid: null,
    message: {
      role,
      content,
    },
  };
};

const firstUserFromConversations = (
  conversations: ReturnType<typeof createUserConversation>[],
) => {
  for (const conversation of conversations) {
    const firstUser = extractFirstUserMessage(conversation);
    if (firstUser !== undefined) return firstUser;
  }
  return null;
};

describe("extractFirstUserMessage", () => {
  it("skips local-command caveat and uses the next user message", () => {
    const caveat =
      "<local-command-caveat>Caveat: The messages below were generated by the user while running local commands. DO NOT respond to these messages or otherwise consider them in your response unless the user explicitly asks you to.</local-command-caveat>";
    const userText = "/create-draft-pr please ignore";
    const stdout =
      "<local-command-stdout>output that should not be first</local-command-stdout>";

    const result = firstUserFromConversations([
      createUserConversation(caveat, "11111111-1111-1111-1111-111111111111"),
      createUserConversation(userText, "22222222-2222-2222-2222-222222222222"),
      createUserConversation(stdout, "33333333-3333-3333-3333-333333333333"),
    ]);

    expect(result?.kind).toBe("text");
    if (result?.kind === "text") {
      expect(result.content).toBe(userText);
    }
  });

  it("skips /clear command and empty local-command-stdout, uses next real user message", () => {
    const caveat =
      "<local-command-caveat>Caveat: The messages below were generated by the user while running local commands. DO NOT respond to these messages or otherwise consider them in your response unless the user explicitly asks you to.</local-command-caveat>";
    const clearCommand =
      "<command-name>/clear</command-name>\n            <command-message>clear</command-message>\n            <command-args></command-args>";
    const emptyStdout = "<local-command-stdout></local-command-stdout>";
    const realUserMessage = "hi, how a u?2";

    const result = firstUserFromConversations([
      createUserConversation(caveat, "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"),
      createUserConversation(
        clearCommand,
        "bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb",
      ),
      createUserConversation(
        emptyStdout,
        "cccccccc-cccc-cccc-cccc-cccccccccccc",
      ),
      createUserConversation(
        realUserMessage,
        "dddddddd-dddd-dddd-dddd-dddddddddddd",
      ),
    ]);

    expect(result?.kind).toBe("text");
    if (result?.kind === "text") {
      expect(result.content).toBe(realUserMessage);
    }
  });

  it("skips empty local-command-stdout as first message", () => {
    const emptyStdout = "<local-command-stdout></local-command-stdout>";
    const result = extractFirstUserMessage(
      createUserConversation(
        emptyStdout,
        "eeeeeeee-eeee-eeee-eeee-eeeeeeeeeeee",
      ),
    );
    expect(result).toBeUndefined();
  });

  it("returns local-command stdout when it is the first non-caveat message", () => {
    const caveat =
      "<local-command-caveat>Caveat: The messages below were generated by the user while running local commands. DO NOT respond to these messages or otherwise consider them in your response unless the user explicitly asks you to.</local-command-caveat>";
    const stdout =
      "<local-command-stdout>hello <tag>world</tag></local-command-stdout>";

    const result = firstUserFromConversations([
      createUserConversation(caveat, "44444444-4444-4444-4444-444444444444"),
      createUserConversation(stdout, "55555555-5555-5555-5555-555555555555"),
    ]);

    expect(result?.kind).toBe("local-command");
    if (result?.kind === "local-command") {
      expect(result.stdout).toBe("hello <tag>world</tag>");
    }
  });
});
